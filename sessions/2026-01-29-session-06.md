# 学习会话记录 - 2026-01-29 Session 06

## 📋 会话信息

| 项目 | 内容 |
|------|------|
| 日期 | 2026-01-29 |
| 时长 | ~60 分钟 |
| 主题 | 项目结构、CMake 包配置机制、DDS 设计哲学 |

---

## 🎯 学习目标

- 理解 Cyclone DDS 项目路线图和目标
- 理解 DDS "共享数据空间" 设计哲学及其实现
- 理解 CMake 包配置机制（find_package 如何工作）
- 更新项目配置（build.sh、README.md）

---

## 📚 学习内容

### 1. ROADMAP.md 翻译

Cyclone DDS 目标实现的 OMG 核心标准：
- **DDS** - 数据分发服务基础规范
- **DDSI-RTPS** - 互操作线路协议
- **DDS-SECURITY** - 安全规范
- **DDS-XTypes** - 可扩展动态类型

### 2. DDS 设计哲学：共享数据空间

**核心观点**：DDS 的本质是 **共享数据空间（Shared Data Space）**，发布-订阅只是实现手段。

| 视角 | 传统消息队列 | DDS 共享数据空间 |
|------|-------------|------------------|
| 核心抽象 | 消息通道 | 全局数据空间 |
| 关注点 | "消息从 A 发送到 B" | "数据的当前状态是什么" |
| 类比 | 邮局投递信件 | 共享白板/数据库 |

### 3. 共享数据空间的实现：WHC/RHC

```
┌─────────────┐      RTPS 协议同步       ┌─────────────┐
│ DataWriter  │ ◄───────────────────►   │ DataReader  │
│   [WHC]     │                         │   [RHC]     │
│ Writer      │                         │ Reader      │
│ History     │                         │ History     │
│ Cache       │                         │ Cache       │
└─────────────┘                         └─────────────┘
```

- **WHC**：写入端缓存，保存待发送/未确认的数据
- **RHC**：读取端缓存，保存接收到的数据供应用读取
- 通过 HEARTBEAT/ACKNACK 机制保证可靠传输

### 4. CMake 包配置机制

#### 文件关系

```
PackageConfig.cmake.in (模板)
         │
         │ configure_package_config_file()
         ▼
CycloneDDSConfig.cmake (生成)
         │
         │ install()
         ▼
<prefix>/lib/cmake/CycloneDDS/CycloneDDSConfig.cmake
```

#### 关键概念

| 概念 | 说明 |
|------|------|
| `@PACKAGE_INIT@` | CMake 占位符，展开为路径计算代码 |
| `CMAKE_CURRENT_LIST_DIR` | 当前 .cmake 文件所在目录 |
| `CMAKE_PREFIX_PATH` | 告诉 CMake 在哪里搜索包 |
| `find_package()` | 搜索并加载包配置文件 |

#### find_package 搜索顺序

1. `CMAKE_PREFIX_PATH` 指定的路径下 `lib/cmake/<PackageName>/`
2. 系统标准路径 `/usr/lib/cmake/`, `/usr/local/lib/cmake/`

### 5. 项目配置文件区分

| 文件 | 用途 |
|------|------|
| `package.xml` | ROS 2 包元数据（colcon 构建用） |
| `cyclonedds.xml` | DDS 运行时配置 |
| `PackageConfig.cmake.in` | CMake 包配置模板 |
| `PkgConfig.pc.in` | pkg-config 配置模板 |

---

## 🔧 实践操作

### 1. 更新 build.sh

- 添加 `-DBUILD_TESTING=ON` 默认选项
- 添加 `reinstall` 命令（clean + build + install）

### 2. 更新 README.md

修正项目结构描述：
- 移除不存在的 `notes/`、`examples/` 目录
- 添加 `dds-standards/` 目录
- 修正 `build/`、`install/`、`logs/` 位置到 `cyclonedds/` 下
- 移除 "git submodule" 错误描述

---

## 🔑 核心收获

1. **DDS 设计哲学**：共享数据空间 > 发布订阅消息
2. **分布式缓存实现**：WHC + RHC + RTPS 同步 = 逻辑上的共享数据空间
3. **CMake 包配置**：`configure_package_config_file()` 生成可重定位的 Config 文件
4. **环境配置**：`CMAKE_PREFIX_PATH` 和 `.envrc` 配合让本地安装的库能被找到

---

## 💡 理解检查答案

**Q: WHC 为什么需要保留"已发送但未确认"的数据？**

A: 类似 TCP 滑动窗口，需要保留数据以支持重传。如果 Reader 通过 ACKNACK 报告丢失某些序列号，Writer 需要从 WHC 中找到对应数据重新发送。

---

## 📝 下次学习计划

1. HelloWorld 示例实践
2. 理解 IDL 编译器的使用
3. 创建自己的 DDS 应用

---

## 📊 相关文件

- `cyclonedds/ROADMAP.md` - 项目路线图
- `cyclonedds/README.md` - 项目说明
- `cyclonedds/src/core/ddsi/include/dds/ddsi/ddsi_whc.h` - WHC 定义
- `cyclonedds/src/core/ddsi/include/dds/ddsi/ddsi_rhc.h` - RHC 定义
- `cyclonedds/PackageConfig.cmake.in` - CMake 配置模板
- `cyclonedds/install/lib/cmake/CycloneDDS/CycloneDDSConfig.cmake` - 生成的配置文件
