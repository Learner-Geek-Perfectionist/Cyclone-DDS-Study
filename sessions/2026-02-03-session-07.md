# å­¦ä¹ ä¼šè¯è®°å½• - 2026-02-03 Session 07

## ğŸ“‹ ä¼šè¯ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| æ—¥æœŸ | 2026-02-03 |
| æ—¶é•¿ | ~45 åˆ†é’Ÿ |
| ä¸»é¢˜ | å¼‚æ­¥å†™å…¥æµç¨‹ã€DDS Security æ’ä»¶æ¶æ„ |

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£ Cyclone DDS å¼‚æ­¥å†™å…¥ï¼ˆasync writeï¼‰çš„å®Œæ•´æµç¨‹
- ç†è§£ DDS Security ä¸‰å¤§æ’ä»¶çš„æ¶æ„å’ŒèŒè´£
- é€šè¿‡æºç æ—¶åºå›¾æ·±å…¥ç†è§£å†…éƒ¨å®ç°

---

## ğŸ“š å­¦ä¹ å†…å®¹

### 1. å¼‚æ­¥å†™å…¥æ—¶åºå›¾åˆ†æ

é€šè¿‡ `async_write_cyclone_dds.png` å­¦ä¹ äº†å®Œæ•´çš„å¼‚æ­¥å†™å…¥æµç¨‹ã€‚

#### dds_create_participant() è°ƒç”¨é“¾

```
App
 â””â”€â”€ dds_create_participant()           â† ç”¨æˆ·è°ƒç”¨çš„ API
      â””â”€â”€ dds_domain_create_internal()   â† åˆ›å»º/è·å–åŸŸå¯¹è±¡
           â””â”€â”€ dds_domain_create_internal_xml_or_raw()  â† è§£æé…ç½®
                â””â”€â”€ dds_domain_init()    â† åˆå§‹åŒ–åŸŸçš„å„é¡¹èµ„æº
                     â””â”€â”€ rtps_init()     â† åˆå§‹åŒ– RTPS åè®®æ ˆ
```

**å…³é”®ç†è§£**ï¼š
- `internal` åç¼€è¡¨ç¤ºå†…éƒ¨å‡½æ•°ï¼Œä¸å¯¹å¤–æš´éœ²
- XML é…ç½®çš„æ˜¯ **Domain å…¨å±€å‚æ•°**ï¼ˆç½‘ç»œã€å‘ç°ã€æ—¥å¿—ï¼‰ï¼Œä¸æ˜¯å•ä¸ª entity çš„ QoS

#### dds_create_writer() ä¸å¼‚æ­¥çº¿ç¨‹

```
dds_create_writer()
    â”‚
    â””â”€â”€ opt [QOS: LatencyBudget > 0]  â† æ¡ä»¶åˆ¤æ–­
            â”‚
            â”œâ”€â”€ nn_xpack_sendq_init()    â† åˆå§‹åŒ–å‘é€é˜Ÿåˆ—
            â””â”€â”€ nn_xpack_sendq_start()   â† åˆ›å»ºåå°å‘é€çº¿ç¨‹
```

**å…³é”®ç†è§£**ï¼š
- `LatencyBudget > 0` æ—¶å¯ç”¨å¼‚æ­¥æ¨¡å¼
- åå°çº¿ç¨‹åœ¨ `dds_create_writer()` æ—¶åˆ›å»ºï¼Œä½†æ­¤æ—¶æ— æ•°æ®
- çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ° `dds_write()` äº§ç”Ÿæ•°æ®

#### dds_create_writer() vs dds_write() çš„èŒè´£

| å‡½æ•° | ä½œç”¨ | ç±»æ¯” |
|------|------|------|
| `dds_create_writer()` | åˆ›å»º Writer + å¯åŠ¨å‘é€çº¿ç¨‹ï¼ˆå¾…å‘½ï¼‰ | é›‡ä½£å¿«é€’å‘˜ |
| `dds_write()` | äº§ç”Ÿæ•°æ®ï¼Œæ”¾å…¥é˜Ÿåˆ— | æŠŠåŒ…è£¹äº¤ç»™å¿«é€’å‘˜ |

#### åå°çº¿ç¨‹å·¥ä½œæµç¨‹

```
loop [ASYNC_MODE || DATA AVAILABLE]
    â””â”€â”€ nn_xpack_sendq_thread()
            â””â”€â”€ nn_xpack_send_real()
                    â””â”€â”€ nn_xpack_send_rtps()
                            â””â”€â”€ ddsi_conn_write()
                                    â””â”€â”€ ddsrt_sendmsg()  â† å‘é€åˆ° socket
```

### 2. Cyclone DDS å‘½åçº¦å®š

| å‰ç¼€/åç¼€ | å«ä¹‰ | ç¤ºä¾‹ |
|-----------|------|------|
| `dds_` | å…¬å¼€ C API | `dds_write()` |
| `dds_*_internal` | å†…éƒ¨å®ç° | `dds_domain_create_internal()` |
| `ddsi_` | DDSI/RTPS å±‚ | `ddsi_serdata_from_sample()` |
| `ddsrt_` | è¿è¡Œæ—¶/å¹³å°æŠ½è±¡å±‚ | `ddsrt_sendmsg()` |
| `nn_` | æ—§ä»£ç ï¼ˆRTPS ç›¸å…³ï¼‰ | `nn_xpack_sendq_start()` |
| `*_impl` | å®ç°å‡½æ•° | `dds_write_impl()` |

### 3. DDS Security ä¸‰å¤§æ’ä»¶

é€šè¿‡ä¸‰å¼  UML ç±»å›¾å­¦ä¹ äº† DDS Security æ¶æ„ã€‚

#### æ’ä»¶åä½œå…³ç³»

```
Authentication Plugin
  â”‚ â†’ IdentityHandleï¼ˆèº«ä»½å¥æŸ„ï¼‰
  â”‚ â†’ SharedSecretHandleï¼ˆå…±äº«å¯†é’¥ï¼‰
  â–¼
Access Control Plugin
  â”‚ â†’ PermissionsHandleï¼ˆæƒé™å¥æŸ„ï¼‰
  â”‚ â†’ å†³å®šä¿æŠ¤çº§åˆ«
  â–¼
Crypto Plugin
  â”‚ â†’ å®é™…åŠ å¯†/è§£å¯†æ“ä½œ
  â–¼
å®‰å…¨çš„ RTPS é€šä¿¡
```

#### Authentication æ’ä»¶

**èŒè´£**ï¼šéªŒè¯"ä½ æ˜¯è°"

| é˜¶æ®µ | æ–¹æ³• | ä½œç”¨ |
|------|------|------|
| æœ¬åœ°éªŒè¯ | `validate_local_identity()` | åŠ è½½æœ¬åœ°è¯ä¹¦ |
| è¿œç¨‹éªŒè¯ | `validate_remote_identity()` | åˆæ­¥éªŒè¯è¿œç¨‹ |
| æ¡æ‰‹ | `begin_handshake_*()`, `process_handshake()` | å¤šè½®æ¡æ‰‹ |
| å¯†é’¥äº¤æ¢ | `get_shared_secret()` | è·å–ä¼šè¯å¯†é’¥ |

**Token vs Handle**ï¼š
- Token = å¯åœ¨ç½‘ç»œä¼ è¾“ï¼ˆå¦‚ IdentityTokenï¼‰
- Handle = æœ¬åœ°å¼•ç”¨ï¼ˆå¦‚ IdentityHandleï¼‰

#### Access Control æ’ä»¶

**èŒè´£**ï¼šæ£€æŸ¥"ä½ èƒ½åšä»€ä¹ˆ"

å®‰å…¨å±æ€§å±‚æ¬¡ï¼š
```
ParticipantSecurityAttributes
  â””â”€â”€ TopicSecurityAttributes
       â””â”€â”€ EndpointSecurityAttributes
```

ä¸»è¦æ–¹æ³•ï¼š
- `check_create_*()` - æ£€æŸ¥æ˜¯å¦å…è®¸åˆ›å»ºå®ä½“
- `check_remote_*()` - æ£€æŸ¥æ˜¯å¦æ¥å—è¿œç¨‹å®ä½“
- `get_*_sec_attributes()` - è·å–å®‰å…¨å±æ€§

#### Crypto æ’ä»¶

**èŒè´£**ï¼šå®é™…åŠ å¯†/è§£å¯†

ä¸‰å¤§æ¥å£ï¼š
1. **CryptoKeyFactory** - åˆ›å»ºåŠ å¯†å¥æŸ„
2. **CryptoKeyExchange** - äº¤æ¢åŠ å¯†ä»¤ç‰Œ
3. **CryptoTransform** - æ‰§è¡ŒåŠ å¯†/è§£å¯†

åŠ å¯†å±‚æ¬¡ï¼š
| æ–¹æ³• | ä¿æŠ¤èŒƒå›´ |
|------|----------|
| `encode_serialized_payload()` | åªåŠ å¯†ç”¨æˆ·æ•°æ® |
| `encode_datawriter_submessage()` | åŠ å¯†æ•´ä¸ªå­æ¶ˆæ¯ï¼ˆç”± Writer å‘å‡ºçš„ï¼‰ |
| `encode_rtps_message()` | åŠ å¯†æ•´ä¸ª RTPS æ¶ˆæ¯ |

### 4. é‡è¦çº æ­£

**é”™è¯¯ç†è§£**ï¼š`encode_datawriter_submessage()` åŠ å¯† "Writer å­æ¶ˆæ¯"

**æ­£ç¡®ç†è§£**ï¼šRTPS æ²¡æœ‰ "Writer å­æ¶ˆæ¯" ç±»å‹ï¼Œè¯¥æ–¹æ³•åŠ å¯†çš„æ˜¯ **ç”± DataWriter å‘å‡ºçš„å­æ¶ˆæ¯**ï¼ˆå¦‚ DATAã€HEARTBEATã€GAPï¼‰

---

## ğŸ”‘ æ ¸å¿ƒæ”¶è·

1. **å¼‚æ­¥å†™å…¥è®¾è®¡**ï¼šLatencyBudget QoS æ§åˆ¶åŒæ­¥/å¼‚æ­¥æ¨¡å¼ï¼Œå¼‚æ­¥å¯æé«˜ååé‡
2. **èŒè´£åˆ†ç¦»**ï¼š`dds_create_writer()` å‡†å¤‡ç¯å¢ƒï¼Œ`dds_write()` äº§ç”Ÿæ•°æ®
3. **å‘½åçº¦å®š**ï¼š`internal`ã€`impl` åç¼€è¡¨ç¤ºå†…éƒ¨å‡½æ•°
4. **Security ä¸‰å±‚æ¶æ„**ï¼šAuthentication â†’ Access Control â†’ Crypto
5. **Token vs Handle**ï¼šToken å¯ç½‘ç»œä¼ è¾“ï¼ŒHandle ä»…æœ¬åœ°å¼•ç”¨

---

## ğŸ’¡ ç†è§£æ£€æŸ¥ç­”æ¡ˆ

**Q: ä¸ºä»€ä¹ˆè¦ç”¨å•ç‹¬çš„çº¿ç¨‹å‘é€ï¼Œè€Œä¸æ˜¯åœ¨ dds_write() ä¸­ç›´æ¥å‘é€ï¼Ÿ**

A: å¼‚æ­¥å†™å…¥è§£è€¦äº†"ç”Ÿäº§æ•°æ®"å’Œ"å‘é€æ•°æ®"ä¸¤ä¸ªæ“ä½œï¼š
- åº”ç”¨çº¿ç¨‹å¯ä»¥å¿«é€Ÿè¿”å›ï¼Œä¸è¢«ç½‘ç»œ I/O é˜»å¡
- åå°çº¿ç¨‹å¯ä»¥æ‰¹é‡å‘é€ï¼Œæé«˜ååé‡
- é€‚åˆé«˜é¢‘æ•°æ®å‘å¸ƒåœºæ™¯

**Q: Token å’Œ Handle çš„åŒºåˆ«ï¼Ÿ**

A: 
- Token åŒ…å«å¯åºåˆ—åŒ–çš„æ•°æ®ï¼Œå¯ä»¥åœ¨ç½‘ç»œä¸Šä¼ è¾“ç»™å…¶ä»–å‚ä¸è€…
- Handle æ˜¯æœ¬åœ°çš„ä¸é€æ˜å¼•ç”¨ï¼Œåªåœ¨æœ¬è¿›ç¨‹å†…æœ‰æ•ˆ

---

## ğŸ“ ä¸‹æ¬¡å­¦ä¹ è®¡åˆ’

1. å®è·µ DDS Security é…ç½®
2. HelloWorld ç¤ºä¾‹è¿è¡Œ
3. è‡ªå®šä¹‰ QoS é…ç½®å®éªŒ

---

## ğŸ“Š ç›¸å…³æ–‡ä»¶

- `cyclonedds/docs/dev/pictures/async_write_cyclone_dds.png` - å¼‚æ­¥å†™å…¥æ—¶åºå›¾
- `cyclonedds/docs/dev/pictures/dds_security_authentication_plugin.png` - Authentication æ’ä»¶
- `cyclonedds/docs/dev/pictures/dds_security_access_control_plugin.png` - Access Control æ’ä»¶
- `cyclonedds/docs/dev/pictures/dds_security_crypto_plugin.png` - Crypto æ’ä»¶
