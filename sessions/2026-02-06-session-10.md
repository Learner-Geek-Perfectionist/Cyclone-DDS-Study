# ğŸ“ å­¦ä¹ ä¼šè¯è®°å½•

> æ—¥æœŸï¼š2026-02-06  
> ä¼šè¯ç¼–å·ï¼šsession-10  
> æ—¶é•¿ï¼šçº¦ 30 åˆ†é’Ÿ

---

## ğŸ¯ æœ¬æ¬¡ç›®æ ‡

- [x] æ·±å…¥ç†è§£ `ddsi_radmin.h` å¤´æ–‡ä»¶ä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„
- [x] æŒæ¡ C è¯­è¨€å˜é•¿ç»“æ„ä½“ï¼ˆStruct Hackï¼‰æŠ€å·§
- [x] ç†è§£ RTPS æŠ¥æ–‡ä¸ Topic çš„å¯¹åº”å…³ç³»

---

## ğŸ“š å­¦ä¹ ä¸»é¢˜

### ä¸»é¢˜ 1ï¼šddsi_rmsg å˜é•¿ç»“æ„ä½“æŠ€å·§

#### æ ¸å¿ƒæ¦‚å¿µ

1. **Struct Hackï¼ˆå˜é•¿ç»“æ„ä½“ï¼‰**: åœ¨ C è¯­è¨€ä¸­ï¼Œé€šè¿‡ä¸€æ¬¡ `malloc` åˆ†é…ç»“æ„ä½“å¤´éƒ¨ + å¯å˜é•¿åº¦è´Ÿè½½çš„è¿ç»­å†…å­˜ã€‚ç”±äº C99 ä¸å…è®¸åµŒå¥—ç»“æ„ä½“ä½¿ç”¨å¯å˜æ•°ç»„æˆå‘˜ï¼ˆ`unsigned char payload[]`ï¼‰ï¼ŒCyclone DDS ä½¿ç”¨ `m + 1` æŒ‡é’ˆè¿ç®—æ¥è·å– Payload åœ°å€ã€‚

2. **`DDSRT_STATIC_ASSERT` ç¼–è¯‘æœŸæ–­è¨€**: ç¡®ä¿ `sizeof(struct ddsi_rmsg)` ç­‰äº `offsetof(struct ddsi_rmsg, chunk) + sizeof(struct ddsi_rmsg_chunk)`ï¼Œä¿è¯ç»“æ„ä½“æœ«å°¾æ²¡æœ‰æ„å¤–çš„ Padding å­—èŠ‚ï¼Œå¦åˆ™ `m + 1` ä¼šè·³è¿‡ç©ºéš™å¯¼è‡´æ•°æ®é”™ä½ã€‚

3. **æŒ‡é’ˆè¿ç®— `m + 1`**: C è¯­è¨€ä¸­æŒ‡é’ˆåŠ æ³•çš„æ­¥é•¿ç­‰äºæ‰€æŒ‡ç±»å‹çš„å¤§å°ã€‚å½“ `m` æ˜¯ `struct ddsi_rmsg *` æ—¶ï¼Œ`m + 1` è·³è¿‡ `sizeof(struct ddsi_rmsg)` ä¸ªå­—èŠ‚ï¼Œåˆšå¥½æŒ‡å‘ç´§éšç»“æ„ä½“ä¹‹åçš„ Payload èµ·å§‹ä½ç½®ã€‚

#### ä»£ç ç¤ºä¾‹

```c
/*
 * ğŸ“Œ ç¤ºä¾‹ï¼šå˜é•¿ç»“æ„ä½“çš„å†…å­˜å¸ƒå±€
 * ğŸ¯ ç›®æ ‡ï¼šç†è§£ DDSI_RMSG_PAYLOAD å®çš„å·¥ä½œåŸç†
 */

// ç¼–è¯‘æœŸç¡®ä¿æ²¡æœ‰å°¾éƒ¨ Padding
DDSRT_STATIC_ASSERT (sizeof (struct ddsi_rmsg) ==
    offsetof (struct ddsi_rmsg, chunk) + sizeof (struct ddsi_rmsg_chunk));

// è·å– Payload èµ·å§‹åœ°å€ï¼šm+1 è·³è¿‡æ•´ä¸ªç»“æ„ä½“å¤´éƒ¨
#define DDSI_RMSG_PAYLOAD(m) ((unsigned char *) (m + 1))

// è·å– Payload ä¸­ç‰¹å®šåç§»å¤„çš„åœ°å€
#define DDSI_RMSG_PAYLOADOFF(m, o) (DDSI_RMSG_PAYLOAD (m) + (o))

// å†…å­˜å¸ƒå±€ï¼š
// [ struct ddsi_rmsg (å¤´éƒ¨) ][ Payload (åŸå§‹ UDP æ•°æ®) ... ]
// ^                         ^
// m                         m + 1 = DDSI_RMSG_PAYLOAD(m)
```

#### ç†è§£è¦ç‚¹

- å®å®šä¹‰æœ¬èº«ä¸åŒ…å«ç±»å‹ä¿¡æ¯ï¼Œ`m` çš„ç±»å‹ç”±è°ƒç”¨å¤„çš„å˜é‡å£°æ˜å†³å®š
- å¼ºè½¬ `(unsigned char *)` æ˜¯ä¸ºäº†å°† Payload å½“ä½œåŸå§‹å­—èŠ‚æµæ“ä½œ
- è¿™ç§è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šå‡å°‘ malloc æ¬¡æ•°ã€å‡å°‘å†…å­˜ç¢ç‰‡ã€æé«˜ Cache å‘½ä¸­ç‡

---

### ä¸»é¢˜ 2ï¼šddsi_rdata é›¶æ‹·è´åæ ‡è®¾è®¡

#### æ ¸å¿ƒæ¦‚å¿µ

1. **é›¶æ‹·è´è®¾è®¡**: `ddsi_rdata` ä¸å­˜å‚¨æ•°æ®æœ¬èº«ï¼Œåªå­˜å‚¨æ•°æ®åœ¨åŸå§‹åŒ…ä¸­çš„åæ ‡ï¼ˆåç§»é‡ï¼‰ï¼Œé¿å…æ•°æ®æ‹·è´ã€‚

2. **uint16_t åç§»é‡ä¼˜åŒ–**: ç”±äº UDP åŒ…æœ€å¤§ 64KBï¼ˆ$2^{16}$ å­—èŠ‚ï¼‰ï¼Œç”¨ `uint16_t`ï¼ˆ2 å­—èŠ‚ï¼‰å­˜å‚¨åç§»é‡è¶³å¤Ÿï¼Œç›¸æ¯” `uint32_t` æˆ–æŒ‡é’ˆæ›´èŠ‚çœå†…å­˜ï¼Œåœ¨æµ·é‡å¯¹è±¡åœºæ™¯ä¸‹æ›´ Cache å‹å¥½ã€‚

3. **ZOFF/OFF è½¬æ¢å®**: åœ¨ Debug æ¨¡å¼ä¸‹åŠ å…¥ `assert` æ–­è¨€æ£€æŸ¥åç§»é‡ä¸è¶…è¿‡ 65536ï¼ŒRelease æ¨¡å¼ä¸‹ç›´æ¥åšç±»å‹è½¬æ¢ï¼Œå…¼é¡¾å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚

#### ä»£ç ç¤ºä¾‹

```c
/*
 * ğŸ“Œ ç¤ºä¾‹ï¼šé€šè¿‡ rdata å®šä½æ•°æ®
 * ğŸ¯ ç›®æ ‡ï¼šç†è§£ "åŸºåœ°å€ + åç§»é‡" çš„æ•°æ®è®¿é—®æ¨¡å¼
 */

struct ddsi_rdata {
  struct ddsi_rmsg *rmsg;         // æŒ‡å‘åŸå§‹æ•°æ®åŒ…ï¼ˆåŸºåœ°å€æ¥æºï¼‰
  struct ddsi_rdata *nextfrag;    // åˆ†ç‰‡é“¾è¡¨
  uint32_t min, maxp1;            // åˆ†ç‰‡å­—èŠ‚èŒƒå›´ [min, maxp1)
  uint16_t submsg_zoff;           // å­æ¶ˆæ¯å¤´åç§»
  uint16_t payload_zoff;          // ç”¨æˆ·æ•°æ®åç§»
  uint16_t keyhash_zoff;          // KeyHash åç§»ï¼ˆ0 è¡¨ç¤ºä¸å­˜åœ¨ï¼‰
};

// ä½¿ç”¨æ–¹å¼ï¼ˆé€»è¾‘ä¸Šç­‰ä»·äºï¼‰ï¼š
// unsigned char *submsg = DDSI_RMSG_PAYLOAD(d->rmsg) + d->submsg_zoff;
// unsigned char *payload = DDSI_RMSG_PAYLOAD(d->rmsg) + d->payload_zoff;
```

#### ç†è§£è¦ç‚¹

- æ³¨é‡Šä¸­æåˆ°åç§»é‡éƒ½æ˜¯ 4 å­—èŠ‚å¯¹é½çš„ï¼Œç†è®ºä¸Š 14 ä½å°±å¤Ÿç”¨
- `submsg_zoff` ç”¨äºå®šä½å­æ¶ˆæ¯å¤´ï¼ˆåŒ…å« Writer Entity ID ç­‰å…ƒä¿¡æ¯ï¼‰
- `payload_zoff` ç”¨äºå®šä½ç”¨æˆ·æ•°æ®ï¼ˆåºåˆ—åŒ–åçš„ CDR æ•°æ®ï¼‰
- `keyhash_zoff` ä¸º 0 è¡¨ç¤ºæ•°æ®åŒ…ä¸­ä¸å« KeyHash

---

### ä¸»é¢˜ 3ï¼šRTPS æŠ¥æ–‡ä¸ Topic çš„å¯¹åº”å…³ç³»

#### æ ¸å¿ƒæ¦‚å¿µ

1. **ä¸€ä¸ª Submessage å¯¹åº”ä¸€ä¸ª Topic**: RTPS DATA å­æ¶ˆæ¯é€šè¿‡ Writer Entity ID å…³è”åˆ°å”¯ä¸€çš„ DataWriterï¼Œè€Œ DataWriter åªç»‘å®šä¸€ä¸ª Topicã€‚

2. **ä¸€ä¸ª UDP åŒ…å¯å«å¤šä¸ª Topic æ•°æ®**: é€šè¿‡å°è£…å¤šä¸ª Submessage å®ç°ï¼Œæ¯ä¸ª Submessage æœ‰ç‹¬ç«‹çš„ Writer Entity IDã€‚

#### ç†è§£è¦ç‚¹

- Batching åªèƒ½æ‰“åŒ…åŒä¸€ Topic çš„å¤šæ¡æ•°æ®ï¼Œä¸èƒ½è·¨ Topic
- è§£æå™¨é€šè¿‡ EntityID æŠŠ Submessage åˆ†å‘ç»™ä¸åŒçš„ DataReader

---

## ğŸ’¡ å¿ƒå¾—ä½“ä¼š

- C è¯­è¨€çš„"å˜é•¿ç»“æ„ä½“"æŠ€å·§åœ¨ç³»ç»Ÿç¼–ç¨‹ï¼ˆç½‘ç»œåè®®æ ˆã€å†…å­˜ç®¡ç†å™¨ï¼‰ä¸­æä¸ºå¸¸è§ï¼Œç†è§£æŒ‡é’ˆè¿ç®—æ˜¯è¯»æ‡‚æ­¤ç±»ä»£ç çš„åŸºç¡€
- Cyclone DDS å¯¹å†…å­˜çš„æè‡´ä¼˜åŒ–ï¼ˆuint16_t åç§»é‡ã€é›¶æ‹·è´è®¾è®¡ï¼‰ä½“ç°äº†é«˜æ€§èƒ½ä¸­é—´ä»¶çš„å·¥ç¨‹æ€ç»´
- å®å®šä¹‰éšè—äº†ç±»å‹ä¿¡æ¯ï¼Œé˜…è¯» C å®ä»£ç æ—¶éœ€è¦ç»“åˆè°ƒç”¨ä¸Šä¸‹æ–‡æ¥æ¨æ–­å‚æ•°ç±»å‹

---

## â“ é—ç•™é—®é¢˜

1. `ddsi_radmin.c` ä¸­ `ddsi_rmsg_new` çš„å®Œæ•´åˆ†é…æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ
2. `ddsi_rdata` çš„ `nextfrag` åˆ†ç‰‡é“¾è¡¨åœ¨ defragmentation ä¸­æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ
3. RTPS Batching æ¨¡å¼ä¸‹ï¼Œå•ä¸ª Submessage Payload å†…å¤šä¸ª Sample çš„å…·ä½“å¸ƒå±€ï¼Ÿ

---

## ğŸ“– å‚è€ƒèµ„æ–™

- æºç ï¼š`cyclonedds/src/core/ddsi/include/dds/ddsi/ddsi_radmin.h`
- æºç ï¼š`cyclonedds/src/core/ddsi/src/ddsi_radmin.c`
- æ–‡æ¡£ï¼š`cyclonedds/docs/dev/data path - receive.svg`

---

## ğŸ¯ ä¸‹æ¬¡ç›®æ ‡

- [ ] é˜…è¯» `ddsi_radmin.c` ä¸­çš„ `ddsi_rmsg_new` / `ddsi_rmsg_commit` å®ç°
- [ ] ç†è§£ defragmentation åˆ†ç‰‡é‡ç»„çš„å®Œæ•´æµç¨‹
- [ ] å­¦ä¹  reorder ä¹±åºå¤„ç†çš„å…·ä½“å®ç°

---

## ğŸ“Š è¿›åº¦æ›´æ–°

| æ¨¡å— | ä¹‹å‰ | ä¹‹å |
|------|------|------|
| ddsi_radmin.h å¤´æ–‡ä»¶ | ğŸ”„ | âœ… |
| æ ¸å¿ƒæ•°æ®ç»“æ„ | ğŸ”„ | ğŸ”„ï¼ˆæŒç»­æ·±å…¥ï¼‰ |
