# 📝 学习会话记录

> **日期**: 2026-01-23  
> **会话编号**: Session 02  
> **时长**: 约 3 小时  
> **主题**: RTPS 行为模块深入、Discovery 协议、高级 DDS 特性

---

## 🎯 本次学习目标

- [x] 深入理解 RTPS Writer/Reader 参考实现
- [x] 掌握 StatelessWriter/StatefulWriter 状态机
- [x] 掌握 StatelessReader/StatefulReader 状态机
- [x] 理解 Discovery 协议（SPDP/SEDP）
- [x] 理解高级 DDS 特性的 RTPS 实现

---

## 📚 学习内容

### 1. RTPS Writer 参考实现

#### StatelessWriter vs StatefulWriter

| 特性 | StatelessWriter | StatefulWriter |
|------|----------------|----------------|
| 状态维护 | 不维护 Reader 状态 | 为每个 Reader 维护 ReaderProxy |
| 适用场景 | Best-Effort、组播 | Reliable、单播 |
| 资源消耗 | 低 | 高 |
| 带宽效率 | 可能重复发送 | 精确重传 |

#### StatefulWriter 状态机转换（可靠模式）

关键转换：
- **T1**: 匹配新 Reader → 创建 ReaderProxy
- **T4**: 有未发送变更 → 发送 DATA/GAP
- **T7**: 周期定时器 → 发送 HEARTBEAT
- **T8**: 收到 ACKNACK → 更新确认/请求集合
- **T12**: 执行重传 → 发送 DATA/GAP

### 2. RTPS Reader 参考实现

#### StatelessReader vs StatefulReader

| 特性 | StatelessReader | StatefulReader |
|------|----------------|----------------|
| 状态维护 | 不维护 Writer 状态 | 为每个 Writer 维护 WriterProxy |
| Reliable 支持 | ❌ 不支持 | ✅ 支持 |
| 重复/乱序检测 | ❌ | ✅ |
| 请求重传 | ❌ | ✅ |

#### ChangeFromWriter 状态

```
UNKNOWN → MISSING → RECEIVED
    ↘         ↘
     → NOT_AVAILABLE (NA_FILTERED / NA_REMOVED / NA_UNSPECIFIED)
```

### 3. Discovery 协议

#### SPDP (Simple Participant Discovery Protocol)

- **目的**: 发现网络上的 Participant
- **特点**: 
  - Best-Effort, Stateless
  - 周期性宣告到预配置地址
  - 使用众所周知的端口
- **数据**: SPDPdiscoveredParticipantData

#### SEDP (Simple Endpoint Discovery Protocol)

- **目的**: 发现 Writer/Reader/Topic
- **特点**:
  - Reliable, Stateful
  - 事件驱动（创建/修改/删除时）
  - 使用 SPDP 获取的 metatraffic 地址
- **数据**: DiscoveredWriterData, DiscoveredReaderData

#### 为什么 SPDP 用 Best-Effort，SEDP 用 Reliable？

| SPDP | SEDP |
|------|------|
| 周期性发送，丢了会再来 | 一次性事件，丢了不重来 |
| 发给未知地址 | 发给已知对端 |
| 发现延迟可容忍 | 端点信息丢失 = 无法匹配 |

### 4. 大数据分片机制

#### Fragment vs DataFrag

- **Fragment**: 数据的逻辑划分单位（固定大小 ≤ 65536）
- **DataFrag**: 传输的子消息，可包含多个连续 Fragment

#### 固定分片大小的原因

- 分片号不依赖于特定 Reader
- 简化 NackFrag 处理
- 支持组播重传

### 5. 高级 DDS 特性

#### Writer Liveliness Protocol

| 类型 | 实现方式 |
|------|---------|
| AUTOMATIC | BuiltinParticipantMessageWriter 周期发送 |
| MANUAL_BY_PARTICIPANT | BuiltinParticipantMessageWriter + 应用触发 |
| MANUAL_BY_TOPIC | HEARTBEAT (LivelinessFlag) |

#### Content-filtered Topics

- Writer 端过滤是可选优化
- 不通过过滤 → 发送 GAP 或 FilteredFlag=1 的 Data
- 过滤签名用于验证过滤参数一致性

#### Group Ordered Access

- PID_GROUP_SEQ_NUM: Publisher 全局序列号
- Subscriber 按 GSN 顺序跨 Writer 提交

#### Coherent Sets

- 一组原子提交的样本
- ECS (End Coherent Set) 消息标记结束
- 不完整的一致性集合被丢弃

---

## 🔑 核心概念总结

| 概念 | 说明 |
|------|------|
| **ReaderProxy** | StatefulWriter 为每个匹配 Reader 维护的状态 |
| **WriterProxy** | StatefulReader 为每个匹配 Writer 维护的状态 |
| **leaseDuration** | Participant 租约时长，超时则认为离线 |
| **metatrafficLocator** | 用于内置端点（Discovery）通信的地址 |
| **defaultLocator** | 用于用户端点通信的默认地址 |
| **availableBuiltinEndpoints** | 声明支持的内置端点（按需） |
| **内联 QoS** | Data 子消息中携带的 QoS 参数 |
| **过滤签名** | 唯一标识过滤器的哈希值 |

---

## 💡 关键理解

### 1. 为什么 Reliable 需要 Stateful？

可靠传输需要追踪每个对端的：
- 已确认序列号
- 缺失序列号
- 重传请求状态

Stateless 无法维护这些信息，因此 Reliable + Stateless = ❌ 不支持

### 2. Discovery 的两层设计

```
SPDP: "我存在" → 获取对方的 metatraffic 地址
        ↓
SEDP: "我有这些 Writer/Reader" → 建立数据通道
```

### 3. 按需端点的设计哲学

- 只实现实际需要的内置端点
- 只发布者 → Publications Writer + Subscriptions Reader
- 只订阅者 → Subscriptions Writer + Publications Reader

---

## 📊 RTPS 协议层次

```
┌─────────────────────────────────────┐
│          DDS 应用程序              │
├─────────────────────────────────────┤
│           DDS API                   │
├─────────────────────────────────────┤
│        RTPS 协议 ⭐                │  ← 应用层中间件协议
├─────────────────────────────────────┤
│         UDP / TCP                   │  ← 传输层
├─────────────────────────────────────┤
│            IP                       │  ← 网络层
└─────────────────────────────────────┘
```

---

## ❓ 遗留问题

1. PSM (Platform Specific Model) 的具体映射细节
2. DDS Security 扩展如何与 RTPS 集成
3. 实际 Cyclone DDS 源码中的实现差异

---

## 🎯 下次学习目标

1. 学习 PSM 章节（UDP/IP 映射）
2. 开始实践：编译 Cyclone DDS
3. 运行 HelloWorld 示例
4. 结合源码理解协议实现

---

## 📖 参考资料

- DDS-RTPS 规范 v2.5（主要学习材料）
- 行为模块：8.4 节
- Discovery 模块：8.5 节
- 版本与扩展：8.6 节
- QoS 实现：8.7 节

---

## 心得体会

本次深入学习了 RTPS 行为模块和 Discovery 协议，对 DDS/RTPS 的工作机制有了系统性理解：

1. **状态机设计精妙**: StatelessWriter/StatefulWriter 和 StatelessReader/StatefulReader 的设计很好地平衡了资源消耗和功能需求

2. **Discovery 分层清晰**: SPDP 和 SEDP 的职责分离使得系统更加模块化，SPDP 用简单的 Best-Effort 发现 Participant，SEDP 用 Reliable 确保端点信息可靠传递

3. **可扩展性考虑周全**: 协议设计充分考虑了版本兼容和扩展性，通过内联 QoS 参数、ParameterList 等机制支持未来扩展

4. **优化与正确性平衡**: Writer 端过滤、消息合并等都是可选优化，确保了基本互操作性的同时允许实现优化

下一步计划从理论学习转向实践，通过编译和运行 Cyclone DDS 示例来验证对协议的理解。
