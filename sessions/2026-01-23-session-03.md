# 📝 学习会话记录

> **日期**: 2026-01-23  
> **会话编号**: Session 03  
> **时长**: 约 2 小时  
> **主题**: PSM UDP/IP 映射、子消息线路格式

---

## 🎯 本次学习目标

- [x] 理解 PSM (Platform Specific Model) 的作用
- [x] 掌握 GUID、EntityId 的具体编码格式
- [x] 理解各种 RTPS 类型的线路表示
- [x] 掌握所有子消息的线路格式

---

## 📚 学习内容

### 1. PSM 概述（第 9 章）

#### 为什么选择 UDP/IP？

| 特性 | 说明 |
|------|------|
| 普遍可用性 | IP 协议栈的核心部分，几乎所有 OS 都支持 |
| 轻量级 | 最小开销 |
| Best-Effort | 匹配实时数据流的 QoS 需求 |
| 无连接 | 多端点共享单个 socket/端口 |
| 可预测行为 | 不像 TCP 有不确定的阻塞时间 |
| 组播支持 | 高效的一对多通信 |

### 2. GUID 和 EntityId 编码

#### GUID 结构（16 字节）
```
GUID = GuidPrefix (12 bytes) + EntityId (4 bytes)
```

#### guidPrefix 约束
```
guidPrefix[0] = vendorId[0]
guidPrefix[1] = vendorId[1]
```
确保不同厂商实现之间 GUID 不冲突。

#### EntityId 编码
```c
struct EntityId_t {
    OctetArray3 entityKey;   // 3 字节，实体键
    octet entityKind;        // 1 字节，实体类型
};
```

entityKind 编码规则：
- 高 2 位：`00` 用户定义，`11` 内置，`01` 厂商特定
- 低 6 位：实体类型（Writer/Reader/有无Key）

| 实体类型 | 用户定义 | 内置 |
|---------|---------|------|
| Writer (with Key) | 0x02 | 0xc2 |
| Writer (no Key) | 0x03 | 0xc3 |
| Reader (no Key) | 0x04 | 0xc4 |
| Reader (with Key) | 0x07 | 0xc7 |

#### 预定义 EntityId

| 实体 | EntityId |
|------|----------|
| SPDP Writer | `{{00,01,00}, c2}` |
| SPDP Reader | `{{00,01,00}, c7}` |
| SEDP Publications Writer | `{{00,00,03}, c2}` |
| SEDP Subscriptions Writer | `{{00,00,04}, c2}` |

**设计原则**：配对端点使用相同的 entityKey，通过 entityKind 区分读写方向。

### 3. Key 和 KeyHash

| 概念 | 说明 |
|------|------|
| **Key** | IDL 中 @key 标记的字段，唯一标识 Instance |
| **KeyHash** | Key 的 16 字节摘要，用于快速查找 |

KeyHash 计算规则：
- Key 序列化后 ≤ 16 字节：直接使用
- Key 序列化后 > 16 字节：使用 MD5 哈希

Key 信息不在序列化数据中，而在类型描述符（Type Descriptor）中。

### 4. ParameterList 可扩展机制

```
+---------------+---------------+---------------+---------------+
|    parameterId (2)            |      length (2)               |
+---------------+---------------+---------------+---------------+
|                      value[length]                            |
+---------------+---------------+---------------+---------------+
|           PID_SENTINEL        |          ignored              |
+---------------+---------------+---------------+---------------+
```

#### ParameterId 空间分配

| 位 | 值 | 含义 |
|----|-----|------|
| bit15 | 0 | 协议保留 |
| bit15 | 1 | 厂商特定 |
| bit14 | 0 | 不识别时跳过忽略 |
| bit14 | 1 | 不识别时当作错误 |

### 5. SequenceNumberSet 位图编码

格式：`bitmapBase/numBits:bitmap`

示例：`100/6:101101` 表示集合 {100, 102, 103, 105}

```
位图:     1   0   1   1   0   1
序列号: 100 101 102 103 104 105
```

### 6. 子消息线路格式

#### Submessage Header（4 字节，所有子消息通用）
```
+---------------+---------------+---------------+---------------+
| submessageId  |    flags    |E|    octetsToNextHeader         |
+---------------+---------------+---------------+---------------+
```

- E = 0: Big-Endian
- E = 1: Little-Endian

#### Data 子消息关键标志
| 位 | 标志 | 含义 |
|----|------|------|
| 1 | Q | 包含 inlineQos |
| 2 | D | 包含序列化数据 |
| 3 | K | 包含序列化 Key |

D/K 组合：
- D=1, K=0：完整数据
- D=0, K=1：仅 Key（dispose/unregister）

#### DataFrag 分片字段

| 字段 | 含义 |
|------|------|
| fragmentStartingNum | 起始分片号 |
| fragmentsInSubmessage | 本消息包含几个分片 |
| fragmentSize | 每个分片的固定大小 |
| sampleSize | 完整样本总大小 |

#### Heartbeat 标志
| 位 | 标志 | 含义 |
|----|------|------|
| 1 | F | FinalFlag：不需要 Reader 响应 |
| 2 | L | LivelinessFlag：刷新 MANUAL_BY_TOPIC 活跃性 |

### 7. RTPS Header（固定 20 字节）

```
+---------------+---------------+---------------+---------------+
|      'R'      |      'T'      |      'P'      |      'S'      |
+---------------+---------------+---------------+---------------+
| major | minor |   vendorId[0] |   vendorId[1] |               |
+---------------+---------------+---------------+---------------+
|                    GuidPrefix (12 bytes)                      |
+---------------+---------------+---------------+---------------+
```

### 8. 重要理解

#### 一个 RTPS 消息 = 来自一个 Participant
- Header 中的 guidPrefix 标识发送方 Participant
- 每个子消息通过 EntityId 区分具体的 Endpoint
- 设计目的：节省带宽，避免重复发送 guidPrefix

#### Discovery 使用普通 Data 子消息
- Discovery 数据没有专门的子消息类型
- 通过 writerId（内置 EntityId）区分
- 数据格式是 ParameterList（而非用户 IDL 类型）

---

## 🔑 核心概念总结

| 概念 | 说明 |
|------|------|
| **PSM** | Platform Specific Model，PIM 到具体平台的映射 |
| **entityKind** | 高 2 位区分来源，低 6 位区分类型 |
| **ANNOUNCER/DETECTOR** | Discovery 端点命名风格（= Writer/Reader） |
| **KeyHash** | Key 的 16 字节摘要，用于快速查找 |
| **ParameterList** | RTPS 核心扩展机制，支持版本兼容 |
| **SequenceNumberSet** | 位图紧凑表示序列号集合 |

---

## 📊 学习进度

DDS-RTPS.txt 学习位置：
- 本次学习：第 5475 行（第 9 章开始）→ 第 7007 行（端口计算部分）
- 下次继续：第 7008 行起（端口计算公式、ParameterId 定义）

---

## 🎯 下次学习目标

1. 完成第 9 章剩余内容（端口计算公式、ParameterId 定义）
2. 学习第 10 章 Serialized Payload Representation
3. 开始实践：编译 Cyclone DDS
4. 运行 HelloWorld 示例

---

## 💡 心得体会

本次深入学习了 PSM 章节，理解了 RTPS 协议在 UDP/IP 上的具体实现：

1. **编码设计精妙**：EntityId 的高 2 位 / 低 6 位分区设计，既紧凑又有足够扩展空间

2. **带宽优化**：guidPrefix 只在 Header 中出现一次，子消息只需发 EntityId（4 字节而非 16 字节）

3. **可扩展性**：ParameterList 的设计使得协议可以平滑演进，新参数不会破坏旧实现

4. **Key/KeyHash 分离**：Key 信息在类型描述符中，KeyHash 作为快速提示避免反序列化开销

5. **统一机制**：Discovery 复用普通的 Data 子消息，体现了"内置端点 = 预配置的普通端点"设计哲学

理论学习已经非常深入，下一步应该转向实践验证！

---

## 📖 参考资料

- DDS-RTPS 规范 v2.5
  - 第 9 章 PSM: UDP/IP
  - 9.3 类型映射
  - 9.4 消息映射
  - 9.5-9.6 协议映射
