# ğŸ“ å­¦ä¹ ä¼šè¯è®°å½•

> æ—¥æœŸï¼š2026-02-26  
> ä¼šè¯ç¼–å·ï¼šsession-13  
> æ—¶é•¿ï¼šçº¦ 90 åˆ†é’Ÿ

---

## ğŸ¯ æœ¬æ¬¡ç›®æ ‡

- [x] ç†è§£ DDS æ•°æ®æ¨¡å‹ï¼šKeyã€Instanceã€Sample çš„ç²¾ç¡®å«ä¹‰å’Œå…³ç³»
- [x] å¤ä¹ å¹¶æ·±å…¥æ¥æ”¶è·¯å¾„ï¼šrbufpoolâ†’rbufâ†’rmsgâ†’rdata çš„å®Œæ•´æµç¨‹
- [x] ç†è§£ defragï¼ˆç¢ç‰‡é‡ç»„ï¼‰å’Œ reorderï¼ˆé‡æ’åºï¼‰çš„å·¥ä½œåŸç†

---

## ğŸ“š å­¦ä¹ ä¸»é¢˜

### ä¸»é¢˜ 1ï¼šDDS æ•°æ®æ¨¡å‹ â€” Key / Instance / Sample

#### æ ¸å¿ƒæ¦‚å¿µ

1. **Type vs Instance vs Sample**ï¼šType æ˜¯ IDL ç¼–è¯‘å™¨ç”Ÿæˆçš„ C ç»“æ„ä½“ï¼ˆè¡¨ç»“æ„ï¼‰ï¼ŒInstance æ˜¯ç”± key å€¼æ ‡è¯†çš„è¿è¡Œæ—¶å¯¹è±¡ï¼ˆè¡¨ä¸­çš„ä¸€è¡Œï¼‰ï¼ŒSample æ˜¯æŸä¸ª Instance çš„ä¸€æ¬¡æ›´æ–°å€¼ï¼ˆè¡Œçš„å†å²ç‰ˆæœ¬ï¼‰
2. **Instance çš„æœ¬è´¨**ï¼šä¸æ˜¯ç¼–è¯‘å™¨äº§ç‰©ï¼Œè€Œæ˜¯åŒ…å«ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆALIVE/DISPOSED/NO_WRITERSï¼‰ã€sample å¾ªç¯é“¾è¡¨ã€å†™å…¥å™¨è®¡æ•°ç­‰ç®¡ç†ä¿¡æ¯çš„è¿è¡Œæ—¶å¯¹è±¡ï¼ˆ`rhc_instance` ç»“æ„ä½“ï¼‰
3. **Key çš„åº•å±‚ä½œç”¨**ï¼šæ˜¯ tkmap å…¨å±€å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•é”®ï¼Œé€šè¿‡ `ddsi_serdata_eqkey()` æ¯”è¾ƒ key å€¼æ¥ç¡®å®š sample å±äºå“ªä¸ª instance
4. **æ—  Key çš„ Topic**ï¼š`serdata_cdr_eqkey()` æ’è¿”å› `true`ï¼Œå¯¼è‡´å…¨å±€åªæœ‰ä¸€ä¸ª instanceï¼Œæ‰€æœ‰ sample å…±äº«åŒä¸€ä¸ª HISTORY depth é™åˆ¶

#### å…³é”®æºç 

- `ddsi_tkmap.c`ï¼š`dds_tk_equals()` è°ƒç”¨ `ddsi_serdata_eqkey()` åˆ¤æ–­ä¸¤ä¸ª sample æ˜¯å¦å±äºåŒä¸€ instance
- `ddsi_serdata_cdr.c`ï¼šæ—  key ç±»å‹çš„ `eqkey` ç›´æ¥è¿”å› `true`
- `dds_rhc_default.c`ï¼š`rhc_instance` ç»“æ„ä½“åŒ…å« iidã€isdisposedã€wrcountã€sample å¾ªç¯é“¾è¡¨

#### ç†è§£è¦ç‚¹

- Key å­—æ®µï¼ˆ`sensor_id`ï¼‰æ˜¯ç±»å‹å®šä¹‰å±‚é¢çš„å£°æ˜
- Key å€¼ï¼ˆ`"kitchen"`ï¼‰æ˜¯è¿è¡Œæ—¶çš„å…·ä½“å€¼ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ª instance
- Instance æ˜¯è¿è¡Œæ—¶å¯¹è±¡ï¼Œç”± key å€¼æ ‡è¯†ä½†åŒ…å«è¿œå¤šäº key å€¼çš„ç®¡ç†ä¿¡æ¯
- QoS ç­–ç•¥ï¼ˆHISTORYã€RESOURCE_LIMITSã€DEADLINE ç­‰ï¼‰éƒ½æ˜¯ per-instance ç²’åº¦ç”Ÿæ•ˆ

### ä¸»é¢˜ 2ï¼šæ¥æ”¶è·¯å¾„å®Œæ•´æµç¨‹å¤ä¹ 

#### æ ¸å¿ƒæ¦‚å¿µ

1. **Socket åŒ…çš„æœ¬è´¨**ï¼šæ“ä½œç³»ç»Ÿä»ç½‘å¡æ”¶åˆ°ä»¥å¤ªç½‘å¸§åï¼Œé€å±‚å‰¥æ‰åè®®å¤´ï¼ˆä»¥å¤ªç½‘â†’IPâ†’UDPï¼‰ï¼Œæœ€ç»ˆæ‹·è´åˆ°ç”¨æˆ· buffer çš„å°±æ˜¯ UDP payload = RTPS æ¶ˆæ¯çš„å­—èŠ‚æµ
2. **æ¥æ”¶çº¿ç¨‹ vs æŠ•é€’çº¿ç¨‹**ï¼šæ¥æ”¶çº¿ç¨‹è´Ÿè´£æ”¶åŒ…â†’è§£æ RTPSâ†’defragâ†’reorderï¼ˆå¿…é¡»åŒæ­¥å®Œæˆï¼Œå› ä¸º rbuf å†…å­˜ç”±å…¶ç‹¬å ï¼‰ï¼›æŠ•é€’çº¿ç¨‹è´Ÿè´£ååºåˆ—åŒ–â†’æŠ•é€’ç»™ RHCï¼ˆè€—æ—¶ï¼Œå¯å¼‚æ­¥ï¼‰
3. **rbufpool å°è£…**ï¼š`ddsi_rmsg_new(rbp)` å†…éƒ¨è°ƒç”¨ `ddsi_rbuf_alloc(rbp)` ä» `rbp->current`ï¼ˆå½“å‰ rbufï¼‰çš„ `freeptr` ä½ç½®åˆ†é…ï¼Œrbuf è¢«å°è£…åœ¨å†…éƒ¨
4. **rmsg çš„çœŸå®å«ä¹‰**ï¼šä¸åªæ˜¯ headerï¼Œæ˜¯æ•´ä¸ª UDP åŒ…çš„å®¹å™¨ã€‚payload åŒºåŸŸä¸åœ¨ç»“æ„ä½“å®šä¹‰ä¸­ï¼Œé€šè¿‡ `(m+1)` æŒ‡é’ˆç®—æœ¯è®¿é—®
5. **freeptr æ˜¯é€»è¾‘æ ‡è®°**ï¼šrbuf çš„ç‰©ç†å†…å­˜åœ¨åˆ›å»ºæ—¶ä¸€æ¬¡æ€§ mallocï¼Œfreeptr åªæ ‡è®°"å·²å ç”¨/å¯ç”¨"çš„è¾¹ç•Œ

#### do_packet() å››æ­¥æµç¨‹

```c
// 1. rmsg_newï¼šåœ¨ rbuf çš„ freeptr ä½ç½®é¢„ç•™ç©ºé—´ï¼ˆfreeptr ä¸æ¨è¿›ï¼‰
rmsg = ddsi_rmsg_new(rbpool);
buff = DDSI_RMSG_PAYLOAD(rmsg);

// 2. conn_readï¼šä» socket æ”¶ UDP åŒ…åˆ° buffï¼ˆ= RTPS æ¶ˆæ¯å­—èŠ‚æµï¼‰
sz = ddsi_conn_read(conn, buff, buff_len, true, &pktinfo);

// 3. setsize + handle_rtps_messageï¼šè®¾ç½®å®é™…å¤§å° + è§£æå¤„ç†
ddsi_rmsg_setsize(rmsg, sz);
handle_rtps_message(..., rmsg, sz, buff, ...);

// 4. commitï¼šæ¥æ”¶çº¿ç¨‹å®£å¸ƒå¤„ç†å®Œæ¯•
ddsi_rmsg_commit(rmsg);
// refcount==0 â†’ freeptr ä¸åŠ¨ï¼Œä¸‹æ¬¡ç›´æ¥è¦†ç›–ï¼ˆé›¶å¼€é”€ï¼‰
// refcount>0  â†’ æ¨è¿› freeptrï¼Œä¿æŠ¤å†…å­˜
```

### ä¸»é¢˜ 3ï¼šBIAS å¼•ç”¨è®¡æ•°çš„å¿…è¦æ€§

#### æ ¸å¿ƒæ¦‚å¿µ

1. **UNCOMMITTED_BIAS (2^31)**ï¼šrmsg_new æ—¶è®¾ç½®ï¼Œæ ‡è®°"æ­£åœ¨è¢«æ¥æ”¶çº¿ç¨‹å¤„ç†"ï¼Œcommit æ—¶å‡å»
2. **RDATA_BIAS (2^20)**ï¼šdefrag ä¿ç•™ rdata æ—¶æ·»åŠ ï¼Œreorder å¤„ç†å®Œåé€šè¿‡ `rmbias_and_adjust(rmsg, actual_refs)` æ›¿æ¢ä¸ºå®é™…å¼•ç”¨æ•°
3. **ä¸ºä»€ä¹ˆéœ€è¦ RDATA_BIAS**ï¼šä¸€ä¸ª rdata å¯èƒ½è¦é€ç»™å¤šä¸ª reader çš„ reorderï¼Œåœ¨éå†æ‰€æœ‰ reader ä¹‹å‰ï¼Œå·²é€å‡ºçš„ reader å¯èƒ½åœ¨æŠ•é€’çº¿ç¨‹ä¸Šå®ŒæˆæŠ•é€’å¹¶ unrefã€‚BIAS å……å½“"å®‰å…¨å«"ï¼Œé˜²æ­¢æå‰é‡Šæ”¾

#### å…³é”®æ—¶åº

- æ•°æ®åœ¨ process() çš„ reorder é˜¶æ®µå°±å·²é€šè¿‡ `dqueue_enqueue()` å…¥äº†æŠ•é€’é˜Ÿåˆ—
- commit ä¸æ˜¯"äº¤ç»™æŠ•é€’çº¿ç¨‹"çš„åŠ¨ä½œï¼Œè€Œæ˜¯"æ¥æ”¶çº¿ç¨‹å®£å¸ƒå¤„ç†å®Œæ¯•"
- æŠ•é€’çº¿ç¨‹å¯èƒ½åœ¨ commit ä¹‹å‰å°±å·²ç»å¼€å§‹å·¥ä½œ

### ä¸»é¢˜ 4ï¼šdefrag ç¢ç‰‡é‡ç»„ â€” fragtree

#### æ ¸å¿ƒæ¦‚å¿µ

1. **defrag çš„ä¸¤å±‚æ ‘**ï¼šsampletreeï¼ˆAVL æ ‘ï¼ŒæŒ‰ seq å·ç´¢å¼•æ­£åœ¨é‡ç»„çš„ rsampleï¼‰â†’ æ¯ä¸ª rsample å†…éƒ¨æœ‰ fragtreeï¼ˆAVL æ ‘ï¼ŒæŒ‰å­—èŠ‚åŒºé—´ç´¢å¼•å·²æ”¶åˆ°çš„ç‰‡æ®µï¼‰
2. **defrag_iv**ï¼šfragtree çš„èŠ‚ç‚¹ï¼Œè®°å½•ä¸€æ®µå·²æ”¶åˆ°çš„è¿ç»­å­—èŠ‚åŒºé—´ `[min, maxp1)` å’Œå¯¹åº”çš„ rdata é“¾
3. **ç›¸é‚»åŒºé—´åˆå¹¶**ï¼šæ”¶åˆ°æ–°ç‰‡æ®µæ—¶ï¼Œå¦‚æœä¸å·²æœ‰åŒºé—´é¦–å°¾ç›¸æ¥ï¼Œåˆå¹¶ä¸ºæ›´å¤§çš„åŒºé—´
4. **é‡ç»„å®Œæˆåˆ¤å®š**ï¼šfragtree åˆå¹¶ä¸ºå•ä¸ª `[0, sample_size)` èŠ‚ç‚¹æ—¶ï¼Œè¯´æ˜æ‰€æœ‰ç‰‡æ®µåˆ°é½
5. **è·¨ rmsg çš„ fragment chain**ï¼šä¸åŒç‰‡æ®µåœ¨ä¸åŒ UDP åŒ…ï¼ˆä¸åŒ rmsgï¼‰ä¸­ï¼Œé€šè¿‡ `rdata->nextfrag` é“¾ä¸²èµ·æ¥ï¼Œæ¯ä¸ª rmsg ç‹¬ç«‹ç»´æŠ¤ refcount

#### reorder é‡æ’åº

- è§£å†³"å¤šä¸ªå®Œæ•´ sample æŒ‰ seq å·æ’å¥½é¡ºåº"çš„é—®é¢˜
- å³ä½¿æ¯ä¸ª sample éƒ½å·²é‡ç»„å®Œæ•´ï¼Œç½‘ç»œåˆ°è¾¾é¡ºåºå¯èƒ½ä¹±åº
- DDS è¦æ±‚æŒ‰ seq é¡ºåºæŠ•é€’ç»™åº”ç”¨å±‚

---

## ğŸ’¡ å¿ƒå¾—ä½“ä¼š

- Key/Instance/Sample çš„ä¸‰å±‚æ¦‚å¿µæ˜¯ç†è§£ DDS "ä»¥æ•°æ®ä¸ºä¸­å¿ƒ"çš„åŸºç¡€ï¼ŒInstance ä¸æ˜¯é™æ€çš„ç±»å‹å®šä¹‰è€Œæ˜¯åŠ¨æ€çš„è¿è¡Œæ—¶å¯¹è±¡
- æ¥æ”¶è·¯å¾„çš„è®¾è®¡å¤„å¤„ä½“ç°æ€§èƒ½ä¼˜å…ˆï¼šé¢„åˆ†é…å¤§å—å†…å­˜é¿å…é¢‘ç¹ mallocã€å•çº¿ç¨‹åˆ†é…é¿å…é”ã€å»¶è¿Ÿæ¨è¿› freeptr å®ç°é›¶å¼€é”€ä¸¢å¼ƒã€BIAS å¼•ç”¨è®¡æ•°é¿å…ç«æ€
- defrag çš„ fragtree ç”¨å­—èŠ‚åŒºé—´è€Œéåˆ†ç‰‡ç¼–å·ç´¢å¼•ï¼Œè¿™ä¸ä¹‹å‰å­¦çš„ rdata çš„ min/maxp1 è®¾è®¡ä¸€è„‰ç›¸æ‰¿
- commit ä¸æ˜¯"äº¤å‡ºå»"çš„åŠ¨ä½œï¼Œè€Œæ˜¯"å£°æ˜å¤„ç†å®Œæ¯•"çš„åŠ¨ä½œï¼Œæ•°æ®åœ¨ process é˜¶æ®µå°±å·²å…¥æŠ•é€’é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶åºç†è§£å¾ˆé‡è¦

---

## â“ é—ç•™é—®é¢˜

1. defrag å’Œ reorder çš„å…·ä½“æºç å®ç°ç»†èŠ‚ï¼ˆåˆå¹¶ç®—æ³•ã€æŠ•é€’åˆ¤å®šé€»è¾‘ï¼‰
2. æŠ•é€’çº¿ç¨‹ï¼ˆdqueueï¼‰çš„å¤„ç†æµç¨‹ï¼šååºåˆ—åŒ– â†’ æŠ•é€’ç»™ RHC çš„å®Œæ•´é“¾è·¯
3. å‘é€è·¯å¾„çš„å†…å­˜ç®¡ç†ï¼ˆxmsg/xpackï¼‰

---

## ğŸ“– å‚è€ƒèµ„æ–™

- æºç ï¼š`cyclonedds/src/core/ddsi/src/ddsi_radmin.c` â€” rbuf/rmsg/rdata/defrag/reorder æ ¸å¿ƒå®ç°
- æºç ï¼š`cyclonedds/src/core/ddsi/include/dds/ddsi/ddsi_radmin.h` â€” rmsg/rmsg_chunk/rdata ç»“æ„ä½“å®šä¹‰
- æºç ï¼š`cyclonedds/src/core/ddsi/src/ddsi_receive.c` â€” æ¥æ”¶çº¿ç¨‹ä¸»å¾ªç¯ do_packet()
- æºç ï¼š`cyclonedds/src/core/ddsi/src/ddsi_tkmap.c` â€” tkmap å…¨å±€ keyâ†’instance æ˜ å°„
- æºç ï¼š`cyclonedds/src/core/ddsi/src/ddsi_serdata_cdr.c` â€” æ—  key ç±»å‹ eqkey æ’è¿”å› true
- æºç ï¼š`cyclonedds/src/core/ddsc/src/dds_rhc_default.c` â€” RHC ä¸­çš„ rhc_instance å’Œ rhc_sample
- æ–‡æ¡£ï¼š`cyclonedds/docs/dev/data path - rbuf.svg` â€” rbuf å†…å­˜å¸ƒå±€å›¾

---

## ğŸ¯ ä¸‹æ¬¡ç›®æ ‡

- [ ] defrag/reorder æºç ç»†èŠ‚ï¼šåˆå¹¶ç®—æ³•ã€æŠ•é€’åˆ¤å®š
- [ ] æŠ•é€’çº¿ç¨‹ dqueue çš„å®Œæ•´å¤„ç†æµç¨‹
- [ ] å‘é€è·¯å¾„æ¦‚è§ˆï¼šxmsg/xpack çš„è®¾è®¡

---

## ğŸ“Š è¿›åº¦æ›´æ–°

| æ¨¡å— | ä¹‹å‰ | ä¹‹å |
|------|------|------|
| IDL æ•°æ®ç±»å‹å®šä¹‰ | ğŸ”„ | âœ… |
| æ ¸å¿ƒæ•°æ®ç»“æ„ (defrag/reorder) | ğŸ”„ | âœ… |
| æ¥æ”¶è·¯å¾„å®Œæ•´æµç¨‹ | ğŸ”„ | âœ… |
