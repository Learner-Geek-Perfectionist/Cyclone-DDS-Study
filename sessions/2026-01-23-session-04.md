# 📝 学习会话记录

> **日期**: 2026-01-23  
> **会话编号**: Session 04  
> **时长**: 约 1.5 小时  
> **主题**: 端口计算、ParameterId 完整定义、SerializedPayload 表示

---

## 🎯 本次学习目标

- [x] 理解端口号计算公式和默认参数
- [x] 理解 ParameterId 的完整定义
- [x] 理解 Discovery 数据为什么用 ParameterList
- [x] 掌握 KeyHash 计算算法
- [x] 理解 SerializedPayload 格式和 RepresentationIdentifier

---

## 📚 学习内容

### 1. 端口号计算公式

#### 默认参数

| 参数 | 默认值 | 含义 |
|------|--------|------|
| **PB** | 7400 | Port Base |
| **DG** | 250 | DomainId Gain |
| **PG** | 2 | ParticipantId Gain |
| **d0** | 0 | Discovery 组播偏移 |
| **d1** | 10 | Discovery 单播偏移 |
| **d2** | 1 | 用户组播偏移 |
| **d3** | 11 | 用户单播偏移 |

#### 端口计算公式

| 流量类型 | 公式 |
|---------|------|
| Discovery 组播 | PB + DG × domainId + d0 |
| Discovery 单播 | PB + DG × domainId + d1 + PG × participantId |
| 用户组播 | PB + DG × domainId + d2 |
| 用户单播 | PB + DG × domainId + d3 + PG × participantId |

#### 示例（Domain 0）

| 端口类型 | Participant 0 | Participant 1 |
|---------|--------------|--------------|
| SPDP 组播 | 7400 | 7400 |
| SPDP 单播 | 7410 | 7412 |
| 用户组播 | 7401 | 7401 |
| 用户单播 | 7411 | 7413 |

**关键理解**：participantId 的作用域是**同一 IP 地址**，不同 IP 的机器可以使用相同的 participantId。

### 2. SPDP 默认配置

| 配置项 | 默认值 |
|--------|--------|
| 组播地址 | **239.255.0.1** |
| 发送周期 | **30 秒** |
| 租约时长 | **100 秒** |

### 3. Discovery 数据为什么用 ParameterList

| 原因 | 说明 |
|------|------|
| **版本兼容** | 新版本添加参数，旧版本可以忽略 |
| **厂商扩展** | 厂商特定参数（bit15=1）不影响互操作 |
| **选择性包含** | 只发送非默认值，节省带宽 |

类比：
- 用户数据 = CSV（只有值，按顺序排列）
- Discovery = JSON（有键名，自描述）

### 4. ParameterId 完整分类

#### Discovery 相关
- PID_PROTOCOL_VERSION (0x0015)
- PID_VENDORID (0x0016)
- PID_PARTICIPANT_GUID (0x0050)
- PID_ENDPOINT_GUID (0x005a)
- PID_BUILTIN_ENDPOINT_SET (0x0058)

#### Locator 相关
- PID_UNICAST_LOCATOR (0x002f)
- PID_MULTICAST_LOCATOR (0x0030)
- PID_DEFAULT_UNICAST_LOCATOR (0x0031)
- PID_METATRAFFIC_UNICAST_LOCATOR (0x0032)

#### QoS 相关
- PID_RELIABILITY (0x001a)
- PID_DURABILITY (0x001d)
- PID_LIVELINESS (0x001b)
- PID_DEADLINE (0x0023)

#### 内联 QoS 特有
- **PID_KEY_HASH** (0x0070)
- **PID_STATUS_INFO** (0x0071)
- PID_COHERENT_SET (0x0056)
- PID_GROUP_SEQ_NUM (0x0064)

### 5. KeyHash 计算算法

#### 步骤
1. 定义 FooKeyHolder：只保留 @key 成员，按 memberId 排序
2. 创建 FooKeyHolderObject：复制 key 值
3. 递归处理嵌套类型
4. PLAIN_CDR2 大端序序列化
5. 生成 KeyHash：
   - ≤16 字节：直接用，末尾填 0
   - >16 字节：计算 MD5

#### 示例
```c
struct Foo { @key long id; long x; };
// id = 0x12345678
// 序列化 = {0x12, 0x34, 0x56, 0x78}
// KeyHash = {0x12, 0x34, 0x56, 0x78, 0x00, ..., 0x00}
```

### 6. StatusInfo_t

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|X|F|U|D|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| 标志 | 含义 |
|------|------|
| D=1 | Instance 被 **disposed** |
| U=1 | Instance 被 **unregistered** |
| F=1 | 样本**未通过**内容过滤 |

### 7. SerializedPayloadHeader

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| representation_identifier (2) | representation_options (2)    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
~                        数据内容                               ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### RepresentationIdentifier 值

| 标识符 | 值 | 用途 |
|--------|-----|------|
| CDR_BE | {0x00, 0x00} | 用户数据，大端序 |
| CDR_LE | {0x00, 0x01} | 用户数据，小端序 |
| **PL_CDR_BE** | {0x00, 0x02} | **Discovery**，大端序 |
| **PL_CDR_LE** | {0x00, 0x03} | **Discovery**，小端序 |
| CDR2_BE | {0x00, 0x10} | CDR v2，大端序 |
| CDR2_LE | {0x00, 0x11} | CDR v2，小端序 |

---

## 🔑 核心概念总结

| 概念 | 说明 |
|------|------|
| **端口计算** | PB + DG×domainId + offset + PG×participantId |
| **participantId 作用域** | 同一 IP 地址，避免端口冲突 |
| **ParameterList vs CDR** | Discovery 用 ParameterList（可扩展），用户数据用 CDR（紧凑） |
| **KeyHash** | Key 的 16 字节摘要，≤16 字节直接用，>16 字节用 MD5 |
| **StatusInfo** | D/U/F 标志表示 dispose/unregister/filtered |
| **RepresentationIdentifier** | 4 字节头部标识数据格式 |

---

## 📊 学习进度

DDS-RTPS.txt 学习位置：
- 本次学习：第 7008 行 → 第 7956 行
- **已完成**：第 9 章 PSM 全部、第 10 章 SerializedPayload 全部
- **剩余**：第 11 章（安全相关）、附录

**DDS-RTPS 规范主体内容学习完成！**

---

## 🎯 下次学习建议

规范学习已基本完成（第 8-10 章），建议：

1. **开始实践**（强烈推荐）：
   - 编译 Cyclone DDS
   - 运行 HelloWorld 示例
   - 用 Wireshark 抓包验证所学知识

2. **可选深入**：
   - DDS Security 扩展
   - Cyclone DDS 源码分析

---

## 💡 心得体会

本次完成了 PSM 章节的剩余部分和 SerializedPayload 章节，对 RTPS 协议的完整图景有了系统理解：

1. **端口设计精巧**：通过简单的公式支持多 Domain、多 Participant 共存

2. **序列化格式分层**：
   - SerializedPayloadHeader 标识格式
   - Discovery 用 ParameterList（灵活）
   - 用户数据用 CDR（高效）

3. **KeyHash 算法细节**：理解了为什么小 key 直接用，大 key 用 MD5

4. **StatusInfo 的作用**：dispose/unregister 不需要发送完整数据，只需 Key + StatusInfo

至此，DDS-RTPS 规范的核心内容（第 8 章 PIM + 第 9 章 PSM + 第 10 章 Serialization）已全部学习完成！理论基础非常扎实，下一步应该转向实践。

---

## 📖 参考资料

- DDS-RTPS 规范 v2.5
  - 9.6.2 端口计算
  - 9.6.3-9.6.4 ParameterId 定义
  - 10 SerializedPayload 表示
