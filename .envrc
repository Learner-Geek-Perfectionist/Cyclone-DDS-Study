# 继承上级环境（home → project 分层覆盖）
source_up_if_exists

# 保存 home 环境（用于 fallback）
_home_path="$PATH"
_home_env=$(env)

# 清除 home 的 manifest 指向，避免 pixi 警告
unset PIXI_PROJECT_MANIFEST

# 激活本项目的 pixi 环境
eval "$(pixi shell-hook)"

# PATH 合并：项目 pixi + home pixi + 系统（去重）
PATH="$PATH:$_home_path"
PATH=$(echo "$PATH" | tr ':' '\n' | awk '!seen[$0]++' | tr '\n' ':' | sed 's/:$//')
export PATH

# 自动 fallback：项目未定义的变量恢复 home 的值（排除 pixi 内部变量）
while IFS='=' read -r _name _value; do
  [[ $_name == PIXI_PROJECT_MANIFEST ]] && continue
  [[ -z "${!_name}" && -n "$_value" ]] && export "$_name=$_value"
done <<< "$_home_env"

unset _home_path _home_env _name _value

# p10k 显示：自动从 pixi.toml 读取项目名
export CONDA_DEFAULT_ENV="$(grep -m1 '^name' pixi.toml 2>/dev/null | sed 's/.*"\(.*\)".*/\1/')"

# ========== 项目特定环境变量 ==========
CYCLONE_INSTALL="$PWD/cyclonedds/install"
path_add LD_LIBRARY_PATH "$CONDA_PREFIX/lib"
path_add LD_LIBRARY_PATH "$CYCLONE_INSTALL/lib"
path_add CMAKE_PREFIX_PATH "$CYCLONE_INSTALL"
